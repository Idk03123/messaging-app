<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PJ's Messaging</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    :root {
      --accent-color: #5865f2;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #2f3136;
      color: #fff;
      height: 100vh;
      display: flex;
    }
    #sidebar {
      width: 250px;
      background: #202225;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    #sidebar h2 {
      padding: 15px;
      font-size: 18px;
      border-bottom: 1px solid #333;
    }
    #friendList, #groupList {
      flex: 1;
      overflow-y: auto;
    }
    .sidebar-item {
      padding: 10px 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sidebar-item:hover {
      background: #2f3136;
    }
    .badge {
      background: red;
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
    }
    #userProfile {
      padding: 10px;
      border-top: 1px solid #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #userProfile img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }
    #chatArea {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #chatHeader {
      padding: 15px;
      border-bottom: 1px solid #333;
      background: #36393f;
      font-weight: bold;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      max-width: 60%;
      padding: 10px;
      border-radius: 10px;
      position: relative;
      display: flex;
      gap: 10px;
    }
    .message img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }
    .message .bubble {
      background: #40444b;
      padding: 10px;
      border-radius: 10px;
    }
    .me .bubble {
      background: var(--accent-color);
    }
    #messageInput {
      display: flex;
      padding: 15px;
      background: #40444b;
      border-top: 1px solid #333;
    }
    #messageInput input {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 5px;
      outline: none;
    }
    #messageInput button {
      margin-left: 10px;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      background: var(--accent-color);
      color: white;
      cursor: pointer;
    }
    #loginScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #2f3136;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #loginBox {
      background: #202225;
      padding: 30px;
      border-radius: 8px;
      width: 300px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #loginBox input {
      padding: 10px;
      border: none;
      border-radius: 5px;
    }
    #loginBox button {
      padding: 10px;
      background: var(--accent-color);
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
    #settingsModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
    }
    #settingsContent {
      background: #202225;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #settingsContent input, #settingsContent textarea, #settingsContent select {
      padding: 8px;
      border: none;
      border-radius: 5px;
    }
    #settingsContent button {
      padding: 8px;
      background: var(--accent-color);
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <div>
      <h2>Friends</h2>
      <div id="friendList"></div>
      <h2>Groups</h2>
      <div id="groupList"></div>
    </div>
    <div id="userProfile">
      <img id="userPfp" src="">
      <span id="userName"></span>
      <button onclick="openSettings()">⚙️</button>
    </div>
  </div>
  <div id="chatArea">
    <div id="chatHeader">Select a chat</div>
    <div id="messages"></div>
    <div id="messageInput">
      <input id="msgBox" placeholder="Type a message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <div id="loginScreen">
    <div id="loginBox">
      <h2>Login</h2>
      <input id="usernameInput" placeholder="Username">
      <input id="passwordInput" placeholder="Password" type="password">
      <button onclick="login()">Login / Register</button>
    </div>
  </div>

  <div id="settingsModal">
    <div id="settingsContent">
      <h2>Settings</h2>
      <input id="newUsername" placeholder="Change Username">
      <input id="newPfp" placeholder="Profile Picture URL">
      <textarea id="badWordsList" placeholder="Bad words (comma separated)"></textarea>
      <label>Theme:
        <select id="themeSelect">
          <option value="#5865f2">Discord Purple</option>
          <option value="#3498db">Blue</option>
          <option value="#2ecc71">Green</option>
          <option value="#e74c3c">Red</option>
          <option value="#e67e22">Orange</option>
        </select>
      </label>
      <label>Custom Color: <input type="color" id="customColor"></label>
      <button onclick="saveSettings()">Save</button>
      <button onclick="closeSettings()">Close</button>
    </div>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBRsCYfrXge2VNF-bjIijK91dYEZ8IYxIk",
    authDomain: "pj-s-messaging.firebaseapp.com",
    databaseURL: "https://pj-s-messaging-default-rtdb.firebaseio.com",
    projectId: "pj-s-messaging",
    storageBucket: "pj-s-messaging.firebasestorage.app",
    messagingSenderId: "294344428209",
    appId: "1:294344428209:web:624a2c618590f843b07090"
  };
  firebase.initializeApp(firebaseConfig);
  const db=firebase.database();

  let userId=null, username="", currentChat=null, globalBadWords=[];

  db.ref('settings/badWords').on('value', snap=>{
    if(snap.exists()) globalBadWords = snap.val();
    else globalBadWords = [];
  });

  function login(){
    const u=document.getElementById('usernameInput').value.trim();
    const p=document.getElementById('passwordInput').value.trim();
    if(!u||!p) return alert("Fill all fields");
    db.ref('users').orderByChild('username').equalTo(u).once('value', snap=>{
      if(snap.exists()){
        let found=false;
        snap.forEach(child=>{
          if(child.val().password===p){
            userId=child.key; username=u;
            found=true;
          }
        });
        if(!found) return alert("Wrong password");
        afterLogin();
      } else {
        userId=db.ref('users').push().key;
        db.ref('users/'+userId).set({username:u,password:p,pfp:"",theme:"#5865f2"});
        username=u;
        afterLogin();
      }
    });
  }

  function afterLogin(){
    document.getElementById('loginScreen').style.display="none";
    db.ref('users/'+userId).on('value', snap=>{
      if(snap.exists()){
        const val=snap.val();
        document.getElementById('userName').innerText=val.username;
        document.getElementById('userPfp').src=val.pfp||"https://i.imgur.com/6VBx3io.png";
        document.documentElement.style.setProperty('--accent-color', val.theme||"#5865f2");
        document.getElementById('themeSelect').value=val.theme||"#5865f2";
        document.getElementById('customColor').value=val.theme||"#5865f2";
      }
    });
  }

  function sendMessage(){
    const box=document.getElementById('msgBox');
    let text=box.value.trim(); if(!text||!currentChat) return;
    globalBadWords.forEach(bw=>{
      const regex=new RegExp("\\b"+bw+"\\b","gi");
      text=text.replace(regex,"#######");
    });
    db.ref('chats/'+currentChat).push({
      sender:userId,
      username:username,
      pfp:document.getElementById('userPfp').src,
      text:text,
      time:Date.now()
    });
    box.value="";
  }

  function openChat(chatId, chatName){
    currentChat=chatId;
    document.getElementById('chatHeader').innerText=chatName;
    const msgDiv=document.getElementById('messages');
    msgDiv.innerHTML="";
    db.ref('chats/'+chatId).off();
    db.ref('chats/'+chatId).on('child_added', snap=>{
      const m=snap.val();
      const div=document.createElement('div');
      div.className="message"+(m.sender===userId?" me":"");
      div.innerHTML=`<img src="${m.pfp||''}"><div class="bubble"><b>${m.username}</b><br>${m.text}</div>`;
      msgDiv.appendChild(div);
      msgDiv.scrollTop=msgDiv.scrollHeight;
    });
  }

  function openSettings(){
    document.getElementById('settingsModal').style.display="flex";
    db.ref('settings/badWords').once('value', snap=>{
      if(snap.exists()) document.getElementById('badWordsList').value=snap.val().join(",");
    });
  }
  function closeSettings(){document.getElementById('settingsModal').style.display="none";}
  function saveSettings(){
    const newU=document.getElementById('newUsername').value.trim();
    const newP=document.getElementById('newPfp').value.trim();
    const bw=document.getElementById('badWordsList').value.split(',').map(w=>w.trim()).filter(w=>w);
    let theme=document.getElementById('customColor').value || document.getElementById('themeSelect').value;
    if(newU) db.ref('users/'+userId).update({username:newU});
    if(newP) db.ref('users/'+userId).update({pfp:newP});
    db.ref('settings/badWords').set(bw);
    db.ref('users/'+userId).update({theme:theme});
    document.documentElement.style.setProperty('--accent-color', theme);
    closeSettings();
  }
</script>
</body>
</html>
